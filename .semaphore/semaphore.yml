version: v1.0
name: CI Build

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Run tests
    task:
      prologue:
        commands:
          - checkout
          - sudo pip3 install https://github.com/amluto/virtme/archive/538f1e756139a6b57a4780e7ceb3ac6bcaa4fe6f.zip
          - sudo apt-get install -y qemu-system-x86
          - sudo apt install -y gcc g++ bison build-essential cmake flex git libedit-dev libllvm9 llvm-9-dev libclang-9-dev python zlib1g-dev libelf-dev libfl-dev
          - pushd /tmp && wget https://github.com/iovisor/bcc/releases/download/v0.16.0/bcc-src-with-submodule.tar.gz && tar xvfz bcc-src-with-submodule.tar.gz && popd
          - mkdir /tmp/bcc/build
          - pushd /tmp/bcc/build && cmake -DPYTHON_CMD=python3 .. && make -j $(nproc) && sudo make install && pushd src/python && make -j $(nproc)  && sudo make install && popd && popd
      env_vars:
        - name: TMPDIR
          value: /tmp
      jobs:
      - name: Run unit tests
        matrix:
          - env_var: KERNEL_VERSION
            values: ["5.9.1-arch1-1"]
        commands:
          - timeout -s KILL 600s ./run-tests.sh $KERNEL_VERSION
